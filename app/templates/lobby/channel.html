{% extends "lobby/base.html" %}

{% block content %}
<div class="vh-100 d-flex flex-column">
    <div class="col"></div>
    <div class="overflow-auto custom-scrollbar">
        <ul class="text-light list-unstyled" id="messageList">
            {% for message in messages %}
            {% include 'lobby/message.html' %}
            {% endfor %}
        </ul>
    </div>
    <div class="border-bottom border-1"></div>
    <div class="input-group my-3">
        <input id="enteredMessage" type="text" class="form-control"
            name="message" autocomplete="off" required>

        <div class="align-items-center d-flex h-100 position-absolute px-3 text-muted w-100 pe-none">
            Press <kbd>/</kbd> to start typing your message...
        </div>

        <button class="btn btn-primary" type="button" id="sendMessage">
            <i class="fa-solid fa-paper-plane"></i>
        </button>
    </div>
</div>
{% endblock content %}

{% block beforebodyend %}
<script>
    const ENTER_KEYCODE = 13;
    let enteredMessage = document.getElementById("enteredMessage");
    let sendMessageBtn = document.getElementById("sendMessage");
    let messageList = document.getElementById("messageList");

    document.onkeyup = function(e) {
        if (e.key === '/') {
            enteredMessage.focus();
        }
    };

    document.addEventListener("DOMContentLoaded", function(e) {
        messageList.children.at(-1)?.scrollIntoView();
    })

    enteredMessage.addEventListener("keypress", function(e) {
        if (e.keyCode === ENTER_KEYCODE) {
            sendMessageBtn.click();
            enteredMessage.value = "";
        }
    });

    sendMessageBtn.addEventListener("click", async function(e) {
        url = "{% url 'add-message' %}";
        let formData = new FormData();
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        formData.append('message', enteredMessage.value);
        formData.append("channelId", {{ selected_channel.id }});

        const response = await fetch(url, {
            method: "POST",
            body: formData,
        });
        const body = await response.text();
        messageList.innerHTML += body;
        messageList.lastChild.scrollIntoView();
    });
</script>
{% endblock beforebodyend %}
